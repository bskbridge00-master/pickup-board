<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ê°„ í”½ì—… ì¼ì •</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: #000000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
      color: #e8e8e8;
      height: 100vh;
      overflow: hidden;
      padding: 8px;
    }
    .container {
      height: 100%;
      border: 1px solid #2a2a4a;
      border-radius: 6px;
      overflow: hidden;
    }
    table {
      width: 100%;
      height: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead th {
      background-color: #1a1a2e;
      color: #e0e0ff;
      font-size: 33px;
      font-weight: bold;
      padding: 8px 16px;
      text-align: center;
      border-bottom: 2px solid #3a3a5c;
    }
    thead th.col-day {
      width: 8%;
      white-space: nowrap;
    }
    thead th.col-regular {
      width: 68%;
      border-left: 1px solid #2a2a4a;
    }
    thead th.col-fresh {
      width: 24%;
      border-left: 1px solid #2a2a4a;
    }
    tbody tr:nth-child(odd) { background-color: #0d0d0d; }
    tbody tr:nth-child(even) { background-color: #141414; }
    tbody td {
      border-bottom: 1px solid #2a2a4a;
      vertical-align: top;
      padding: 12px 16px;
    }
    tbody td.day-cell {
      text-align: center;
      vertical-align: middle;
      border-right: 1px solid #2a2a4a;
      padding: 12px 8px;
    }
    .day-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      min-height: 40px;
      border-radius: 6px;
      background-color: #1a1a2e;
      color: #8a8aff;
      font-weight: bold;
      font-size: 28px;
    }
    tbody td.content-cell {
      font-size: 25px;
      color: #e8e8e8;
      border-left: 1px solid #2a2a4a;
      line-height: 1.6;
    }
    .empty-cell { color: #555; }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 24px;
      color: #8a8aff;
    }
    .error-msg {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 18px;
      color: #ff6b6b;
      gap: 12px;
      padding: 20px;
    }
    .error-msg button {
      padding: 8px 20px;
      background: #1a1a2e;
      color: #e0e0ff;
      border: 1px solid #3a3a5c;
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
    }
    .error-msg button:hover { background: #2a2a4a; }
    .th-content { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .icon { width: 20px; height: 20px; }
    .help-text { font-size: 14px; color: #888; line-height: 1.8; text-align: center; }

    /* âœ… ì˜¤ëŠ˜(í˜„ì¬ ìš”ì¼) í•˜ì´ë¼ì´íŠ¸: í•´ë‹¹ ìš”ì¼(í–‰) ì „ì²´ ê°•ì¡° */
    tr.today-row td {
      background: rgba(255, 215, 0, 0.20);
    }
    tr.today-row td.day-cell {
      background: rgba(255, 215, 0, 0.35);
    }
    .day-badge.today {
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.8);
      background-color: rgba(255, 215, 0, 0.4);
      color: #000000;
    }
    /* ì˜¤ëŠ˜ ë‚ ì§œ ë¼ë²¨ë„ ì‚´ì§ ê°•ì¡° */
    .today-date {
      color: #FFD700 !important;
      font-weight: 700;
    }


    /* âœ… FHD ê³ ì • í‘œì‹œ: 6í–‰(ì›”~í† )ì´ í™”ë©´ì— í•­ìƒ ëª¨ë‘ ë³´ì´ë„ë¡ */
    table { height: 100%; }
    tbody td.content-cell {
      overflow: hidden;
      word-break: keep-all;
      white-space: normal;
    }
    .cell-text {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.35;
    }

  
    /* âœ… í–‰ ë†’ì´ëŠ” ë°ì´í„°ëŸ‰ì— ë”°ë¼ ê°€ë³€(ì›”~í† ëŠ” ëª¨ë‘ í™”ë©´ì— í‘œì‹œ) */
    tbody tr { height: auto; }

    /* ê¸€ì í¬ê¸°ëŠ” ê³ ì • (ì…€ ë†’ì´ë¡œ í•´ê²°) */
    tbody td.content-cell { 
      font-size: 25px;
      line-height: 1.35;
      white-space: normal;
      word-break: keep-all;
      overflow: hidden;
    }
    /* ì •ê¸°ê³µêµ¬/ì‹ ì„ ê³µêµ¬ ê¸°ë³¸ ê¸€ì í¬ê¸° ì‚´ì§ êµ¬ë¶„(ì›í•˜ë©´ ë™ì¼í•˜ê²Œë„ ê°€ëŠ¥) */
    tbody td.content-cell.regular { font-size: 24px; }
    tbody td.content-cell.fresh { font-size: 22px; }

  
    /* âœ… ë¶€ë“œëŸ¬ìš´ ê°±ì‹ (í˜ì´ë“œ) */
    .fade-layer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.0);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.35s ease;
      z-index: 9998;
    }
    .fade-layer.show {
      opacity: 1;
      background: rgba(0,0,0,0.22);
    }

  
    
    /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” v2: ë” ì‘ì€ ê¸€ì”¨ + ìš”ì¼ ì»¬ëŸ¼ ì •ë¦¬ */
    @media (max-width: 768px) {
      body {
        height: auto;
        overflow: auto;
        padding: 6px;
      }

      .container {
        height: auto;
        min-height: 100vh;
      }

      table {
        height: auto;
      }

      tbody tr {
        height: auto !important;
      }

      thead th {
        font-size: 16px;
        padding: 6px 6px;
      }

      /* ìš”ì¼ ì»¬ëŸ¼ í­ ì¶•ì†Œ */
      thead th.col-day {
        width: 12%;
      }

      .day-badge {
        width: 26px;
        min-height: 26px;
        font-size: 14px;
        border-radius: 4px;
      }

      tbody td {
        padding: 8px 6px;
      }

      tbody td.day-cell {
        padding: 6px 4px;
      }

      tbody td.content-cell {
        font-size: 14px !important;
        line-height: 1.3;
      }

      tbody td.content-cell.fresh {
        font-size: 13px !important;
      }

      .th-content {
        flex-direction: column;
        gap: 2px;
      }

      .th-content .icon {
        display: none;
      }
    }

    /* ğŸ“± ëª¨ë°”ì¼ ì¹´ë“œí˜• UI */
    @media (max-width: 768px) {
      #tableView { display: none; }
      #mobileView { display: block; padding: 6px; }
    }
    @media (min-width: 769px) {
      #mobileView { display: none; }
    }

    .day-card {
      background: #111;
      border: 1px solid #2a2a4a;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .day-card h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #FFD700;
    }
    .card-section {
      margin-bottom: 6px;
      font-size: 14px;
      line-height: 1.4;
    }
    .card-section strong {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
      color: #aaa;
    }

  
    
    /* ğŸ“± ì˜¤ëŠ˜ ì¹´ë“œ ê°•í™” ìŠ¤íƒ€ì¼ */
    .day-card.today-card {
      border: 2px solid #FFD700;
      background: linear-gradient(180deg, #2a2200 0%, #141100 100%);
      box-shadow: 0 0 22px rgba(255, 215, 0, 0.35);
    }
    .day-card.today-card h3 {
      color: #FFD700;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .today-badge {
      background: #FFD700;
      color: #000;
      font-size: 11px;
      font-weight: 900;
      padding: 3px 6px;
      border-radius: 20px;
    }
    .day-card.today-card .card-section {
      font-weight: 800;
      color: #FFF3B0;
    }


  
    /* ğŸ“± ì˜¤ëŠ˜ í”½ì—… ë°°ë„ˆ */
    .today-pickup-banner {
      background: linear-gradient(90deg, #FFD700, #FFC300);
      color: #000;
      font-size: 12px;
      font-weight: 900;
      text-align: center;
      padding: 4px 0;
      border-radius: 6px;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }

  </style>
</head>
<body>
  <div class="container" id="app">
    <div id="tableView"></div>
    <div id="mobileView"></div>
    <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>


  <!-- âœ… ìƒíƒœ/ì˜¤ë¥˜ ì˜¤ë²„ë ˆì´ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì‹œë„ í‘œì‹œ) -->
  <div id="statusOverlay" style="
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.55); z-index: 9999;">
    <div style="
      width: min(720px, 92vw);
      background: #0d0d0d;
      border: 1px solid #3a3a5c;
      border-radius: 10px;
      padding: 18px 20px;
      color: #e8e8e8;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    ">
      <div style="font-size: 20px; font-weight: 800; color:#FFD700; margin-bottom: 10px;">ì—°ê²° ìƒíƒœ</div>
      <div id="statusMsg" style="font-size: 16px; line-height: 1.6; color:#ddd; margin-bottom: 12px;">-</div>
      <div style="display:flex; gap:10px; align-items:center; justify-content: space-between; flex-wrap: wrap;">
        <div id="retryInfo" style="font-size: 14px; color:#aaa;">-</div>
        <button id="retryNowBtn" style="
          padding: 8px 14px; background: #1a1a2e; color: #e0e0ff;
          border: 1px solid #3a3a5c; border-radius: 8px; cursor: pointer;
          font-size: 14px; font-weight: 700;
        ">ì§€ê¸ˆ ë‹¤ì‹œ ì‹œë„</button>
      </div>
    </div>
  </div>

  <div id="fadeLayer" class="fade-layer"></div>


  <script>
    // ---- KST(Asia/Seoul) ê¸°ì¤€ ë‚ ì§œ ê³„ì‚° ìœ í‹¸ ----
    function kstNow() {
      // ì–´ë””ì„œ ì—´ì–´ë„ KST ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë˜ë„ë¡ UTC millisecondsì— +9ì‹œê°„ ì ìš©
      return new Date(Date.now() + 9 * 60 * 60 * 1000);
    }
    function pad2(n) { return String(n).padStart(2, '0'); }
    function formatMMDD(d) {
      // dëŠ” KST ê¸°ì¤€ìœ¼ë¡œ ë§Œë“  Dateì´ë¯€ë¡œ UTC getterë¡œ ê³ ì •
      var m = d.getUTCMonth() + 1;
      var day = d.getUTCDate();
      return m + '/' + pad2(day);
    }
    // ì´ë²ˆ ì£¼ ì›”~í†  ë‚ ì§œ ë°°ì—´ (KST ê¸°ì¤€)
    function getWeekDatesMonToSat() {
      var now = kstNow();
      var dow = now.getUTCDay();          // 0=ì¼..6=í† 
      var monIndex = (dow + 6) % 7;       // ì›”=0..ì¼=6
      var base = new Date(Date.UTC(
        now.getUTCFullYear(),
        now.getUTCMonth(),
        now.getUTCDate()
      ));
      base.setUTCDate(base.getUTCDate() - monIndex);
      var arr = [];
      for (var i = 0; i < 6; i++) {
        var d = new Date(base.getTime());
        d.setUTCDate(base.getUTCDate() + i);
        arr.push(d);
      }
      return arr; // [ì›”..í† ]
    }
    // ì˜¤ëŠ˜ ìš”ì¼ì„ ì›”=0..ì¼=6 í˜•íƒœë¡œ (KST ê¸°ì¤€)
    function getMonIndexKST() {
      var now = kstNow();
      var dow = now.getUTCDay();          // 0=ì¼..6=í† 
      return (dow + 6) % 7;               // ì›”=0..ì¼=6
    }

    var SHEET_ID = '1dT6o_xh8SpCeDdVOnG9PWTgDJhTTQ53yCv_-m4aybsg';
    var TABS = ['ì •ê¸°ê³µêµ¬', 'ì‹ ì„ ê³µêµ¬'];
    var DAYS = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    var allEntries = [];
    var loadedCount = 0;
    var callbackCount = 0;

    var packageIcon = '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>';
    var leafIcon = '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>';

    // âœ… ë¶€ë“œëŸ¬ìš´ ê°±ì‹ (í˜ì´ë“œ) + ë°ì´í„° ì¬ë¡œë”©
    var isLoading = false;
    var activeScripts = [];
    var retryTimer = null;
    var retryCountdownTimer = null;
    var retryAttempt = 0;

    function showFade(on) {
      var f = document.getElementById('fadeLayer');
      if (!f) return;
      if (on) f.classList.add('show');
      else f.classList.remove('show');
    }

    function showStatus(msg, retrySec) {
      var o = document.getElementById('statusOverlay');
      var m = document.getElementById('statusMsg');
      var r = document.getElementById('retryInfo');
      var btn = document.getElementById('retryNowBtn');
      if (!o || !m || !r || !btn) return;

      m.textContent = msg || 'ì—°ê²° ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.';
      if (typeof retrySec === 'number') {
        r.textContent = 'ìë™ ì¬ì‹œë„ê¹Œì§€ ' + retrySec + 'ì´ˆ';
      } else {
        r.textContent = '';
      }
      o.style.display = 'flex';

      btn.onclick = function() {
        clearRetryTimers();
        retryAttempt = 0;
        o.style.display = 'none';
        softRefresh(true);
      };
    }

    function hideStatus() {
      var o = document.getElementById('statusOverlay');
      if (o) o.style.display = 'none';
    }

    function clearRetryTimers() {
      if (retryTimer) { clearTimeout(retryTimer); retryTimer = null; }
      if (retryCountdownTimer) { clearInterval(retryCountdownTimer); retryCountdownTimer = null; }
    }

    function scheduleRetry(reason) {
      clearRetryTimers();
      // 1íšŒ: 10ì´ˆ, 2íšŒ: 20ì´ˆ, 3íšŒ: 40ì´ˆ ... ìµœëŒ€ 300ì´ˆ
      retryAttempt = Math.min(retryAttempt + 1, 6);
      var retrySec = Math.min(10 * Math.pow(2, retryAttempt - 1), 300);

      showStatus(reason || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', retrySec);

      var left = retrySec;
      retryCountdownTimer = setInterval(function() {
        left -= 1;
        if (left <= 0) left = 0;
        showStatus(reason || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', left);
        if (left <= 0) {
          clearInterval(retryCountdownTimer);
          retryCountdownTimer = null;
        }
      }, 1000);

      retryTimer = setTimeout(function() {
        hideStatus();
        softRefresh(true);
      }, retrySec * 1000);
    }

    function cleanupScripts() {
      // JSONPë¡œ ì¶”ê°€í•œ script íƒœê·¸ ëˆ„ì  ë°©ì§€
      for (var i = 0; i < activeScripts.length; i++) {
        try {
          if (activeScripts[i] && activeScripts[i].parentNode) {
            activeScripts[i].parentNode.removeChild(activeScripts[i]);
          }
        } catch (e) {}
      }
      activeScripts = [];
    }

    function softRefresh(force) {
      if (isLoading && !force) return;
      showFade(true);
      setTimeout(function() {
        loadData(); // ì„±ê³µ/ì‹¤íŒ¨ëŠ” ì½œë°±/ì—ëŸ¬í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬
      }, 150);
    }

    // âœ… HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml2(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }


    

    // âœ… ë°ì´í„°ëŸ‰(ê¸€ììˆ˜/í•­ëª©ìˆ˜)ì— ë”°ë¼ í–‰ ë†’ì´ë¥¼ ê°€ë³€ìœ¼ë¡œ ë°°ë¶„
    // - ì›”~í†  6í–‰ì€ í•­ìƒ í‘œì‹œ(ì´í•© 100%)
    // - ìµœì†Œ/ìµœëŒ€ ë¹„ì¤‘ì„ ë‘ì–´ í•œ ìš”ì¼ì´ ê³¼ë„í•˜ê²Œ ì»¤ì§€ì§€ ì•Šê²Œ í•¨
    function computeRowHeights(entries) {
      var heights = [];
      var scores = [];
      var minPct = 10;   // ìµœì†Œ 10% (6í–‰ì´ë©´ ìµœì†Œ 60%)
      var maxPct = 26;   // ìµœëŒ€ 26% (í•œ í–‰ì´ ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒ ë°©ì§€)

      // ì ìˆ˜ ê³„ì‚° (ì •ê¸°/ì‹ ì„  ì¤‘ ë” ë§ì€ ìª½ ê¸°ì¤€)
      for (var i = 0; i < DAYS.length; i++) {
        var day = DAYS[i];
        var todayIdx = (function(){
          var now = new Date(Date.now() + 9 * 60 * 60 * 1000);
          var dow = now.getUTCDay();
          return (dow + 6) % 7;
        })();
        var isToday = (i === todayIdx);
        var reg = getContent(entries, day, 'ì •ê¸°ê³µêµ¬') || '';
        var fre = getContent(entries, day, 'ì‹ ì„ ê³µêµ¬') || '';

        var regLine = reg.split('\n').filter(function(s){ return s.trim(); }).join(', ');
        var freLine = fre.split('\n').filter(function(s){ return s.trim(); }).join(', ');

        function scoreText(t) {
          if (!t) return 0;
          var items = t.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
          var itemCount = Math.max(1, items.length);
          var charCount = t.length;
          return charCount + Math.max(0, itemCount - 4) * 18;
        }

        var s = Math.max(scoreText(regLine), scoreText(freLine));
        // ë¹ˆ ìš”ì¼ë„ ìµœì†ŒëŠ” ë³´ì´ê²Œ
        if (s <= 0) s = 35;
        scores.push(s);
      }

      // ì ìˆ˜ë¥¼ 1~2.6 ì •ë„ì˜ ê°€ì¤‘ì¹˜ë¡œ ë³€í™˜
      // (ë„ˆë¬´ ê¸¸ë©´ ì»¤ì§€ê³ , ì§§ìœ¼ë©´ ì‘ì•„ì§€ë˜ ê¸‰ê²©í•˜ì§€ ì•Šê²Œ)
      var weights = scores.map(function(s) {
        var w = 1 + Math.min(1.6, Math.max(0, (s - 60) / 140)); // s=60 ì´í•˜ -> 1, s=284 ì´ìƒ -> 2.6 ê·¼ì²˜
        return w;
      });

      var sumW = weights.reduce(function(a,b){ return a+b; }, 0);
      heights = weights.map(function(w){ return (w / sumW) * 100; });

      // ìµœì†Œ/ìµœëŒ€ í¼ì„¼íŠ¸ í´ë¨í”„ í›„ ë‹¤ì‹œ ì •ê·œí™”
      var clamped = heights.map(function(p){ return Math.min(maxPct, Math.max(minPct, p)); });
      var sumC = clamped.reduce(function(a,b){ return a+b; }, 0);
      var normalized = clamped.map(function(p){ return (p / sumC) * 100; });

      // ì†Œìˆ˜ì  2ìë¦¬ë¡œ ì •ë¦¬
      return normalized.map(function(p){ return p.toFixed(2); });
    }
function parseResponse(json, tabName) {
      var results = [];
      var rows = json.table.rows || [];
      var numCols = json.table.cols ? json.table.cols.length : 0;

      for (var colIdx = 0; colIdx < DAYS.length && colIdx < numCols; colIdx++) {
        var day = DAYS[colIdx];
        var items = [];
        for (var rowIdx = 0; rowIdx < rows.length; rowIdx++) {
          var cell = rows[rowIdx].c ? rows[rowIdx].c[colIdx] : null;
          var value = cell ? cell.v : null;
          if (value && String(value).trim()) {
            items.push(String(value).trim());
          }
        }
        results.push({
          category: tabName,
          dayOfWeek: day,
          content: items.join('\n')
        });
      }
      return results;
    }

    function getContent(entries, day, category) {
      for (var i = 0; i < entries.length; i++) {
        if (entries[i].dayOfWeek === day && entries[i].category === category) {
          return entries[i].content;
        }
      }
      return '';
    }

    
    // ğŸ“± ëª¨ë°”ì¼ ì¹´ë“œ ë Œë”ë§
    function renderMobile(entries) {
      var container = document.getElementById('mobileView');
      if (!container) return;

      var htmlCard = '';
      for (var i = 0; i < DAYS.length; i++) {
        var day = DAYS[i];
        var todayIdx = (function(){
          var now = new Date(Date.now() + 9 * 60 * 60 * 1000);
          var dow = now.getUTCDay();
          return (dow + 6) % 7;
        })();
        var isToday = (i === todayIdx);
        var reg = getContent(entries, day, 'ì •ê¸°ê³µêµ¬') || '';
        var fre = getContent(entries, day, 'ì‹ ì„ ê³µêµ¬') || '';

        var regLine = reg.split('\n').filter(function(s){return s.trim();}).join(', ') || '-';
        var freLine = fre.split('\n').filter(function(s){return s.trim();}).join(', ') || '-';

        htmlCard += '<div class="day-card' + (isToday ? ' today-card' : '') + '">';
        if (isToday) { htmlCard += '<div class="today-pickup-banner">ğŸ”¥ ì˜¤ëŠ˜ í”½ì—…</div>'; }
        htmlCard += '<h3>' + day + (isToday ? '<span class="today-badge">TODAY</span>' : '') + '</h3>';
        htmlCard += '<div class="card-section"><strong>ì •ê¸°ê³µêµ¬</strong>' + regLine + '</div>';
        htmlCard += '<div class="card-section"><strong>ì‹ ì„ ìƒí’ˆ</strong>' + freLine + '</div>';
        htmlCard += '</div>';
      }
      container.innerHTML = htmlCard;
    }
function renderTable(entries) {
      var weekDates = getWeekDatesMonToSat();
      var todayIdx = getMonIndexKST();
      var highlightIdx = (todayIdx >= 0 && todayIdx <= 5) ? todayIdx : -1;
      var html = '<table><thead><tr>';
      html += '<th class="col-day">ìš”ì¼</th>';
      html += '<th class="col-regular"><div class="th-content">' + packageIcon + 
    '<span>ì •ê¸°ê³µêµ¬ìƒí’ˆ</span>' +
    '<div style="font-size: 20px;color:#FFD700;margin-top:4px;">(' + formatMMDD(weekDates[0]) + ' ~ ' + formatMMDD(weekDates[5]) + ')</div>' +
    '</div></th>';
      html += '<th class="col-fresh"><div class="th-content">' + leafIcon + '<span>ì‹ ì„ ìƒí’ˆ</span></div></th>';
      html += '</tr></thead><tbody>';

      var rowHeights = computeRowHeights(entries);

for (var i = 0; i < DAYS.length; i++) {
        var day = DAYS[i];
        var todayIdx = (function(){
          var now = new Date(Date.now() + 9 * 60 * 60 * 1000);
          var dow = now.getUTCDay();
          return (dow + 6) % 7;
        })();
        var isToday = (i === todayIdx);
        var trClass = (i === highlightIdx) ? ' class="today-row"' : '';
        html += '<tr' + trClass + ' style=\"height:' + rowHeights[i] + '%\">';
        var dateLabel = formatMMDD(weekDates[i]);
        var isToday = (i === highlightIdx);
        html += '<td class="day-cell"><div style="display:flex;flex-direction:column;align-items:center;gap:6px;">' +
                '<span class="day-badge' + (isToday ? ' today' : '') + '">' + day + '</span>' +
                '<div style="font-size: 20px;color:#aaa;" class="' + (isToday ? 'today-date' : '') + '">' + dateLabel + '</div>' +
                '</div></td>';

        for (var j = 0; j < TABS.length; j++) {
          var cat = TABS[j];
          var content = getContent(entries, day, cat);
          var display = '';
          if (content) {
            display = content.split('\n').filter(function(s) { return s.trim(); }).join(', ');
          } else {
            display = '';
          }

          var cellClass = (cat === 'ì •ê¸°ê³µêµ¬') ? 'regular' : 'fresh';

          if (display) {
            html += '<td class="content-cell ' + cellClass + '">' + escapeHtml2(display) + '</td>';
          } else {
            html += '<td class="content-cell ' + cellClass + '"><span class="empty-cell">-</span></td>';
          }
}

        html += '</tr>';
      }

      html += '</tbody></table>';
      return html;
    }

    function showError(msg) {
      // ê¸°ì¡´ í…Œì´ë¸”ì€ ìœ ì§€í•˜ê³ , ì˜¤ë²„ë ˆì´ë¡œ ì˜¤ë¥˜ ì•ˆë‚´ + ìë™ ì¬ì‹œë„
      showFade(false);
      isLoading = false;
      scheduleRetry(msg || 'ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ë¬¸ì œë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    function handleSheetData(response, tabIndex) {
      try {
        var tabName = TABS[tabIndex];
        var entries = parseResponse(response, tabName);
        allEntries = allEntries.concat(entries);
        loadedCount++;

        if (loadedCount === TABS.length) {
          document.getElementById('tableView').innerHTML = renderTable(allEntries);
          renderMobile(allEntries);
          isLoading = false;
          hideStatus();
          showFade(false);
        }
      } catch (e) {
        console.error(e);
        showError('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    window.sheetCallback0 = function(response) {
      callbackCount++;
      if (response.status === 'error') {
        showError('ì •ê¸°ê³µêµ¬ ì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      handleSheetData(response, 0);
    };

    window.sheetCallback1 = function(response) {
      callbackCount++;
      if (response.status === 'error') {
        showError('ì‹ ì„ ê³µêµ¬ ì‹œíŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      handleSheetData(response, 1);
    };

    function loadData() {
      var weekDates = getWeekDatesMonToSat();
      isLoading = true;
      cleanupScripts();
      clearRetryTimers();
allEntries = [];
      loadedCount = 0;
      callbackCount = 0;

      // âœ… ì‘ë‹µ ì§€ì—° ëŒ€ë¹„ ì›Œì¹˜ë… (8ì´ˆ ì•ˆì— ì‘ë‹µ ì—†ìœ¼ë©´ ìë™ ì¬ì‹œë„ ì•ˆë‚´)
      var loadWatchdog = setTimeout(function() {
        if (isLoading && loadedCount < TABS.length) {
          showError('ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        }
      }, 8000);

      for (var i = 0; i < TABS.length; i++) {
        var script = document.createElement('script');
        var url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID +
          '/gviz/tq?sheet=' + encodeURIComponent(TABS[i]) +
          '&range=B2:G20' +
          '&tqx=responseHandler:sheetCallback' + i;
        script.src = url;
        script.onerror = function() {
          showError('Google ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };
        document.body.appendChild(script);
        activeScripts.push(script);
      }
    }

    loadData();

    // ğŸ”„ 5ë¶„ë§ˆë‹¤ ë¶€ë“œëŸ½ê²Œ ìë™ ê°±ì‹  (í˜ì´ì§€ ì „ì²´ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹  ë°ì´í„°ë§Œ ì¬ë¡œë”©)
    setInterval(function() {
      softRefresh();
    }, 300000);
  </script>
</body>
</html>
