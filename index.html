<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>주간 픽업 일정</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background-color: #000000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', '맑은 고딕', sans-serif;
      color: #e8e8e8;
      height: 100vh;
      overflow: hidden;
      padding: 8px;
    }
    .container {
      height: 100%;
      border: 1px solid #2a2a4a;
      border-radius: 6px;
      overflow: hidden;
    }
    table {
      width: 100%;
      height: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead th {
      background-color: #1a1a2e;
      color: #e0e0ff;
      font-size: 33px;
      font-weight: bold;
      padding: 8px 16px;
      text-align: center;
      border-bottom: 2px solid #3a3a5c;
    }
    thead th.col-day {
      width: 8%;
      white-space: nowrap;
    }
    thead th.col-regular {
      width: 64%;
      border-left: 1px solid #2a2a4a;
    }
    thead th.col-fresh {
      width: 28%;
      border-left: 1px solid #2a2a4a;
    }
    tbody tr:nth-child(odd) { background-color: #0d0d0d; }
    tbody tr:nth-child(even) { background-color: #141414; }
    tbody td {
      border-bottom: 1px solid #2a2a4a;
      vertical-align: top;
      padding: 12px 16px;
    }
    tbody td.day-cell {
      text-align: center;
      vertical-align: middle;
      border-right: 1px solid #2a2a4a;
      padding: 12px 8px;
    }
    .day-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      min-height: 40px;
      border-radius: 6px;
      background-color: #1a1a2e;
      color: #8a8aff;
      font-weight: bold;
      font-size: 28px;
    }
    tbody td.content-cell {
      font-size: 25px;
      color: #e8e8e8;
      border-left: 1px solid #2a2a4a;
      line-height: 1.6;
    }
    .empty-cell { color: #555; }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 24px;
      color: #8a8aff;
    }
    .error-msg {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 18px;
      color: #ff6b6b;
      gap: 12px;
      padding: 20px;
    }
    .error-msg button {
      padding: 8px 20px;
      background: #1a1a2e;
      color: #e0e0ff;
      border: 1px solid #3a3a5c;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .error-msg button:hover { background: #2a2a4a; }
    .th-content { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .icon { width: 20px; height: 20px; }
    .help-text { font-size: 14px; color: #888; line-height: 1.8; text-align: center; }

    /* ✅ 오늘(현재 요일) 하이라이트: 해당 요일(행) 전체 강조 */
    tr.today-row td {
      background: rgba(138, 138, 255, 0.10);
    }
    tr.today-row td.day-cell {
      background: rgba(138, 138, 255, 0.18);
    }
    .day-badge.today {
      box-shadow: 0 0 0 2px rgba(138, 138, 255, 0.55);
      background-color: #2a2a4a;
      color: #e0e0ff;
    }
    /* 오늘 날짜 라벨도 살짝 강조 */
    .today-date {
      color: #e0e0ff !important;
      font-weight: 700;
    }

</style>
</head>
<body>
  <div id="weekTitle" style="text-align:center;color:#e0e0ff;font-size:22px;margin:6px 0 10px;"></div>
  <div class="container" id="app">
    <div class="loading">데이터를 불러오는 중...</div>
  </div>

  <script>
    // ---- KST(Asia/Seoul) 기준 날짜 계산 유틸 ----
    function kstNow() {
      // 어디서 열어도 KST 기준으로 계산되도록 UTC milliseconds에 +9시간 적용
      return new Date(Date.now() + 9 * 60 * 60 * 1000);
    }
    function pad2(n) { return String(n).padStart(2, '0'); }
    function formatMMDD(d) {
      // d는 KST 기준으로 만든 Date이므로 UTC getter로 고정
      var m = d.getUTCMonth() + 1;
      var day = d.getUTCDate();
      return m + '/' + pad2(day);
    }
    // 이번 주 월~토 날짜 배열 (KST 기준)
    function getWeekDatesMonToSat() {
      var now = kstNow();
      var dow = now.getUTCDay();          // 0=일..6=토
      var monIndex = (dow + 6) % 7;       // 월=0..일=6
      var base = new Date(Date.UTC(
        now.getUTCFullYear(),
        now.getUTCMonth(),
        now.getUTCDate()
      ));
      base.setUTCDate(base.getUTCDate() - monIndex);
      var arr = [];
      for (var i = 0; i < 6; i++) {
        var d = new Date(base.getTime());
        d.setUTCDate(base.getUTCDate() + i);
        arr.push(d);
      }
      return arr; // [월..토]
    }
    // 오늘 요일을 월=0..일=6 형태로 (KST 기준)
    function getMonIndexKST() {
      var now = kstNow();
      var dow = now.getUTCDay();          // 0=일..6=토
      return (dow + 6) % 7;               // 월=0..일=6
    }

    var SHEET_ID = '1dT6o_xh8SpCeDdVOnG9PWTgDJhTTQ53yCv_-m4aybsg';
    var TABS = ['정기공구', '신선공구'];
    var DAYS = ['월', '화', '수', '목', '금', '토'];
    var allEntries = [];
    var loadedCount = 0;
    var callbackCount = 0;

    var packageIcon = '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>';
    var leafIcon = '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>';

    function parseResponse(json, tabName) {
      var results = [];
      var rows = json.table.rows || [];
      var numCols = json.table.cols ? json.table.cols.length : 0;

      for (var colIdx = 0; colIdx < DAYS.length && colIdx < numCols; colIdx++) {
        var day = DAYS[colIdx];
        var items = [];
        for (var rowIdx = 0; rowIdx < rows.length; rowIdx++) {
          var cell = rows[rowIdx].c ? rows[rowIdx].c[colIdx] : null;
          var value = cell ? cell.v : null;
          if (value && String(value).trim()) {
            items.push(String(value).trim());
          }
        }
        results.push({
          category: tabName,
          dayOfWeek: day,
          content: items.join('\n')
        });
      }
      return results;
    }

    function getContent(entries, day, category) {
      for (var i = 0; i < entries.length; i++) {
        if (entries[i].dayOfWeek === day && entries[i].category === category) {
          return entries[i].content;
        }
      }
      return '';
    }

    function renderTable(entries) {
      var weekDates = getWeekDatesMonToSat();
      var todayIdx = getMonIndexKST();
      var highlightIdx = (todayIdx >= 0 && todayIdx <= 5) ? todayIdx : -1;
      var html = '<table><thead><tr>';
      html += '<th class="col-day">요일</th>';
      html += '<th class="col-regular"><div class="th-content">' + packageIcon + '<span>정기공구상품</span></div></th>';
      html += '<th class="col-fresh"><div class="th-content">' + leafIcon + '<span>신선상품</span></div></th>';
      html += '</tr></thead><tbody>';

      var rowHeight = (100 / 6).toFixed(2);

      for (var i = 0; i < DAYS.length; i++) {
        var day = DAYS[i];
        var trClass = (i === highlightIdx) ? ' class="today-row"' : '';
        html += '<tr' + trClass + ' style="height:' + rowHeight + '%">';
        var dateLabel = formatMMDD(weekDates[i]);
        var isToday = (i === highlightIdx);
        html += '<td class="day-cell"><div style="display:flex;flex-direction:column;align-items:center;gap:6px;">' +
                '<span class="day-badge' + (isToday ? ' today' : '') + '">' + day + '</span>' +
                '<div style="font-size:16px;color:#aaa;" class="' + (isToday ? 'today-date' : '') + '">' + dateLabel + '</div>' +
                '</div></td>';

        for (var j = 0; j < TABS.length; j++) {
          var cat = TABS[j];
          var content = getContent(entries, day, cat);
          var display = '';
          if (content) {
            display = content.split('\n').filter(function(s) { return s.trim(); }).join(', ');
          } else {
            display = '<span class="empty-cell">-</span>';
          }
          html += '<td class="content-cell">' + display + '</td>';
        }

        html += '</tr>';
      }

      html += '</tbody></table>';
      return html;
    }

    function showError(msg) {
      document.getElementById('app').innerHTML =
        '<div class="error-msg">' +
        '<div>' + msg + '</div>' +
        '<div class="help-text">Google 스프레드시트 공유 설정을 확인해 주세요:<br>' +
        '1. 스프레드시트 열기<br>' +
        '2. 파일 메뉴 → "공유" → "다른 사용자와 공유"<br>' +
        '3. "일반 액세스"를 "링크가 있는 모든 사용자"로 변경<br>' +
        '4. 역할을 "뷰어"로 설정 후 "완료" 클릭</div>' +
        '<button onclick="location.reload()">다시 시도</button>' +
        '</div>';
    }

    function handleSheetData(response, tabIndex) {
      try {
        var tabName = TABS[tabIndex];
        var entries = parseResponse(response, tabName);
        allEntries = allEntries.concat(entries);
        loadedCount++;

        if (loadedCount === TABS.length) {
          document.getElementById('app').innerHTML = renderTable(allEntries);
        }
      } catch (e) {
        console.error(e);
        showError('데이터 처리 중 오류가 발생했습니다.');
      }
    }

    window.sheetCallback0 = function(response) {
      if (response.status === 'error') {
        showError('정기공구 시트를 불러올 수 없습니다.');
        return;
      }
      handleSheetData(response, 0);
    };

    window.sheetCallback1 = function(response) {
      if (response.status === 'error') {
        showError('신선공구 시트를 불러올 수 없습니다.');
        return;
      }
      handleSheetData(response, 1);
    };

    function loadData() {
      var weekDates = getWeekDatesMonToSat();
      var wt = document.getElementById('weekTitle');
      if (wt) wt.textContent = '주간 픽업 일정 (' + formatMMDD(weekDates[0]) + ' ~ ' + formatMMDD(weekDates[5]) + ')';

      allEntries = [];
      loadedCount = 0;

      for (var i = 0; i < TABS.length; i++) {
        var script = document.createElement('script');
        var url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID +
          '/gviz/tq?sheet=' + encodeURIComponent(TABS[i]) +
          '&range=B2:G20' +
          '&tqx=responseHandler:sheetCallback' + i;
        script.src = url;
        script.onerror = function() {
          showError('Google 스프레드시트에 연결할 수 없습니다.');
        };
        document.body.appendChild(script);
      }
    }

    loadData();
  </script>
</body>
</html>
